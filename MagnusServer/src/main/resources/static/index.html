<html>
<head>
    <title>Magnus</title>
    <script src="jquery.js"></script>
    <script>
        var streamersData;
        var streamPlayer;
        var onlineTable;
        var offlineTable;

        var intervalId;

        $(document).ready(onReady);

        function onReady() {
            streamPlayer = document.getElementById("streamPlayer");
            onlineTable = document.getElementById("onlineTable");
            offlineTable = document.getElementById("offlineTable");

            $('#button').click(function(){
                clearInterval(intervalId);
                hideStreamItems();
            });
            hideStreamItems();

            $.ajax({
				type: 'GET',
				dataType: 'json',
				url: '/get_streamers_list',
				success: function(data) {
                    console.log(data);
					onObtainedStreamersInfo(data);
				}
			});
        }

        function onObtainedStreamersInfo(data) {
            streamersData = data;

            $(onlineTable).children().remove();
            let i = 0;
            for(const streamer of data.onlineStreamers) {
                addRow(onlineTable, i, streamer);
                i++
            }

            $(offlineTable).children().remove();
            i = 0;
            for(const streamer of data.offlineStreamers) {
                addRow(offlineTable, i, streamer.streamerInfo, "(Last seen: " + streamer.lastSeen + ")");
                i++;
            }
        }

        function addRow(table, i, streamer, additionalInfo) {
            let row = table.insertRow(i);
            let cell = row.insertCell(0);
            cell.innerHTML = "<u>" + streamer.name + "</u> " + (additionalInfo != undefined ? additionalInfo : "");

            if(table == onlineTable){
                cell.onclick = function() {
                    let container = document.getElementById("currentStreamer");
                    container.innertHTML = streamer.login + "\n" + streamer.name + "\n" + streamer.department + "\n" +
                        streamer.jobName + "\n" + streamer.phoneNumber + "\n" + streamer.email;

                    clearInterval(intervalId);
                    showStreamItems();
                    intervalId = setInterval(function() {
                        streamPlayer.src = "/screenshot?login=" + streamersData.onlineStreamers[0].login + "&nocache=" + Math.floor(Math.random() * 1000000);
                        if(streamPlayer.src == null) console.log("errorrrrrr");
                    }, 200);
                };
            }
        }

        function hideStreamItems(){
            $('#streamTitle').hide();
            $('#streamPlayer').hide();
            $('#button').hide();
        };

        function showStreamItems(){
            $('#streamTitle').show();
            $('#streamPlayer').show();
            $('#button').show();
        }


	</script>
</head>
<body>
    <div>Online:</div>
    <table id="onlineTable"></table>
    <div>Offline:</div>
    <table id="offlineTable"></table>
    <div id="currentStreamer"></div>
    <div id="streamTitle">Stream:</div>
    <img id="streamPlayer" height="300px">
    <div></div>
    <button id="button">Close stream</button>
</body>
</html>
